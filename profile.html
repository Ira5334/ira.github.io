<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Особистий кабінет</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
 <header>
    <h1>Готель "ГОРИЗОНТ"</h1>
    <nav>
        <ul>
            <li><a href="index.html">Головна</a></li>
            <li><a href="rooms.html">Номери</a></li>
            <li><a href="services.html">Послуги</a></li>
            <li><a href="promotions.html">Акції та події</a></li>
            <li><a href="contact.html">Контакти</a></li>
        </ul>
    </nav>
</header>

<main>
  <section class="user-info">
    <h2>Особисті дані</h2>
   <div id="user-info">
  <p>Ім'я: <span id="first-name"></span></p>
  <p>Прізвище: <span id="last-name"></span></p>
  <p>Телефон: <span id="phone-number"></span></p>
  <button onclick="enableEdit()">Редагувати</button>
</div>

<div id="edit-form" style="display:none;">
  <label>Ім'я: <input type="text" id="edit-first-name" /></label><br />
  <label>Прізвище: <input type="text" id="edit-last-name" /></label><br />
  <label>Телефон: <input type="text" id="edit-phone-number" /></label><br />
  <button onclick="submitChanges()">Змінити</button>
</div>
  </section>

  <section class="history">
    <h2>Історія бронювань</h2>
    <ul id="reservations-list"></ul>
  </section>

  <section class="services">
    <h2 id="services-toggle">Замовлення послуг ▼</h2>
    <div id="services-menu" style="display: none;">
      <details>
        <summary>Їжа в номер</summary>
        <label><input type="checkbox" data-price="150" /> Борщ - 150 грн</label>
        <label><input type="checkbox" data-price="120" /> Вареники - 120 грн</label>
      </details>

      <details>
        <summary>Спа-процедури</summary>
        <label><input type="checkbox" data-price="500" /> Масаж спини - 500 грн</label>
      </details>

      <details>
        <summary>Хімчистка</summary>
        <label><input type="checkbox" data-price="300" /> Костюм - 300 грн</label>
      </details>

      <details>
        <summary>Прибирання</summary>
        <label><input type="checkbox" data-price="200" /> Прибирання номера - 200 грн</label>
      </details>

      <label for="comments">Коментар до замовлення:</label>
      <textarea id="comments"></textarea>

      <p><strong>Сума: <span id="total">0</span> грн</strong></p>
      <button id="submit-order">Оформити замовлення</button>
      <p id="order-status"></p>
    </div>
  </section>
</main>

<script>
  const API_BASE = 'https://backend-production-a854.up.railway.app';
  const userEmail = localStorage.getItem('userEmail'); // Отримуємо email замість userId

  document.addEventListener('DOMContentLoaded', () => {
    if (!userEmail) {
      // Якщо email не збережено, редірект на сторінку входу
      window.location.href = 'login.html';
    }

    // Завантаження даних користувача
    fetch(`${API_BASE}/api/user/email/${encodeURIComponent(userEmail)}`)
      .then(res => res.json())
      .then(data => {
document.getElementById('first-name').textContent = data.first_name;
document.getElementById('last-name').textContent = data.last_name;
document.getElementById('phone-number').textContent = data.phone_number;
      })
      .catch(error => console.log("Error loading user data:", error));

    // Завантаження історії бронювань
   fetch(`${API_BASE}/api/reservations/${userEmail}`)
      .then(res => res.json())
      .then(data => {
        const list = document.getElementById('reservations-list');
        data.forEach(r => {
          const li = document.createElement('li');
          li.textContent = `${r.room_type}, ${r.check_in_date} - ${r.check_out_date} [${r.status}]`;
          list.appendChild(li);
        });
      })
      .catch(error => console.log("Error loading reservations:", error));

    // Збереження змін користувача
    document.getElementById('user-form').addEventListener('submit', e => {
      e.preventDefault();
      fetch(`${API_BASE}/api/user/email/${encodeURIComponent(userEmail)}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: userEmail,
          first_name: document.getElementById('first_name').value,
          last_name: document.getElementById('last_name').value,
          phone_number: document.getElementById('phone').value
        })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || 'Зміни збережено!');
      })
      .catch(error => console.log("Error saving user data:", error));
    });

    // Управління меню послуг
    document.getElementById('services-toggle').addEventListener('click', () => {
      const menu = document.getElementById('services-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
    });

    // Підрахунок суми замовлення послуг
    document.querySelectorAll('input[type=checkbox]').forEach(box => {
      box.addEventListener('change', () => {
        let total = 0;
        document.querySelectorAll('input[type=checkbox]:checked').forEach(c => {
          total += parseInt(c.dataset.price);
        });
        document.getElementById('total').textContent = total;
      });
    });

    // Оформлення замовлення
  document.getElementById('submit-order').addEventListener('click', () => {
  const selected = [];
  document.querySelectorAll('input[type=checkbox]:checked').forEach(c => {
    selected.push({
      name: c.parentElement.textContent.trim(),
      price: parseInt(c.dataset.price)
    });
  });

  const order = {
    email: userEmail,
    items: selected,
    comment: document.getElementById('comments').value
  };

  fetch(`${API_BASE}/api/orders`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(order)
  })
    .then(res => res.json())
    .then(data => {
      document.getElementById('order-status').textContent = data.message || 'Замовлення прийнято!';
    })
    .catch(err => {
      console.error(err);
      document.getElementById('order-status').textContent = 'Помилка під час оформлення.';
    });
});
// Функції редагування
  function enableEdit() {
    document.getElementById('edit-form').style.display = 'block';
    document.getElementById('user-info').style.display = 'none';

    document.getElementById('edit-first-name').value = document.getElementById('first-name').textContent;
    document.getElementById('edit-last-name').value = document.getElementById('last-name').textContent;
    document.getElementById('edit-phone-number').value = document.getElementById('phone-number').textContent;
  }

  function submitChanges() {
    fetch(`${API_BASE}/api/user/email/${encodeURIComponent(userEmail)}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: userEmail,
        first_name: document.getElementById('edit-first-name').value,
        last_name: document.getElementById('edit-last-name').value,
        phone_number: document.getElementById('edit-phone-number').value
      })
    })
    .then(res => res.json())
    .then(data => {
      alert(data.message || 'Зміни збережено!');
      location.reload();
    })
    .catch(error => {
      console.log("Помилка під час збереження:", error);
      alert('Не вдалося зберегти зміни');
    });
  }
</script>

</body>
</html>
